<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Dashboard</title>
    <script src="./vendor/xlsx-loader.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { background: white; padding: 30px 40px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        header h1 { font-size: 32px; color: #333; }
        .header-controls { display: flex; gap: 10px; flex-wrap: wrap; }
        .control-button { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .control-button:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .main-content { display: grid; grid-template-columns: 1fr 350px; gap: 30px; margin-bottom: 30px; }
        .dashboard-section { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .sidebar { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 800px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; text-align: center; }
        .stat-box.passed { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .stat-box.failed { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .stat-value { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; text-transform: uppercase; }
        .results-list { margin-top: 20px; }
        .result-item { padding: 15px; margin-bottom: 12px; background: #f8f9fa; border-left: 4px solid #999; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .result-item.passed { border-left-color: #27ae60; background: #f0fdf4; }
        .result-item.failed { border-left-color: #e74c3c; background: #fef2f2; }
        .result-name { font-size: 14px; font-weight: 600; color: #333; flex-grow: 1; }
        .result-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .result-status.passed { background: #27ae60; color: white; }
        .result-status.failed { background: #e74c3c; color: white; }
        .sidebar-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
        .history-item { padding: 12px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; border-left: 3px solid #999; }
        .history-item:hover { background: #e9ecef; transform: translateX(5px); }
        .history-item.active { background: #667eea; color: white; border-left-color: #667eea; }
        .history-run { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .history-time { font-size: 11px; opacity: 0.7; }
        .history-stats { font-size: 11px; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(0,0,0,0.1); }
        .back-button { padding: 12px 24px; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px; }
        .back-button:hover { background: #667eea; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">‚Üê Back to Hub</a>
        <header>
            <h1>‚è±Ô∏è Advanced Dashboard</h1>
            <div class="header-controls">
                <button class="control-button" onclick="exportToExcel()">
                    <span>üìä</span> Export to Excel
                </button>
            </div>
        </header>
        <div class="main-content">
            <div class="dashboard-section">
                <h2 style="color: #333; margin-bottom: 20px;">Current Test Run</h2>
                <div class="stats-grid">
                    <div class="stat-box passed"><div class="stat-value" id="passedCount">-</div><div class="stat-label">Passed</div></div>
                    <div class="stat-box failed"><div class="stat-value" id="failedCount">-</div><div class="stat-label">Failed</div></div>
                    <div class="stat-box"><div class="stat-value" id="totalCount">-</div><div class="stat-label">Total</div></div>
                    <div class="stat-box"><div class="stat-value" id="successRate">-</div><div class="stat-label">Success %</div></div>
                </div>
                <div class="results-list" id="resultsList"></div>
            </div>
            <div class="sidebar">
                <div class="sidebar-title">üìú Recent Runs</div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>
    <script>
        let allHistoryData = [];
        let currentDataIndex = 0;
        
        async function loadAndParseTestData() {
            try {
                const response = await fetch('./json/mochawesome.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const newRun = { timestamp: new Date().toISOString(), data: data };
                // Avoid duplicating the same latest run when reloading
                const latest = allHistoryData[0];
                if (!latest || JSON.stringify(latest.data) !== JSON.stringify(data)) {
                    allHistoryData.unshift(newRun);
                    currentDataIndex = 0;
                    saveHistoryToLocalStorage();
                } else {
                    currentDataIndex = 0;
                }
                renderDashboard(allHistoryData[currentDataIndex].data);
                populateHistory();
                // enable export button when data present
                setExportEnabled(true);
            } catch (error) {
                console.error('Error loading mochawesome.json:', error);
                // If fetch fails but we have stored history, render it so export still works
                if (allHistoryData.length > 0) {
                    renderDashboard(allHistoryData[currentDataIndex].data);
                    populateHistory();
                    setExportEnabled(true);
                } else {
                    // no data available ‚Äî ensure export is disabled and inform user
                    setExportEnabled(false);
                    console.warn('No test data available to render or export.');
                }
            }
        }
        
        function renderDashboard(data) {
            const stats = data.stats;
            document.getElementById('passedCount').textContent = stats.passes;
            document.getElementById('failedCount').textContent = stats.failures;
            document.getElementById('totalCount').textContent = stats.tests;
            document.getElementById('successRate').textContent = stats.passPercent + '%';
            displayTestResults(data.results);
        }
        
        function displayTestResults(results) {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            results.forEach(result => {
                if (result.suites && result.suites.length > 0) {
                    result.suites.forEach(suite => {
                        suite.tests.forEach(test => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'result-item ' + (test.pass ? 'passed' : 'failed');
                            resultItem.innerHTML = `
                                <div class="result-name">${test.title}</div>
                                <div class="result-status ${test.pass ? 'passed' : 'failed'}">${test.pass ? 'PASSED' : 'FAILED'}</div>
                            `;
                            resultsList.appendChild(resultItem);
                        });
                    });
                }
            });
        }
        
        function populateHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            allHistoryData.forEach((run, index) => {
                const date = new Date(run.timestamp);
                const stats = run.data.stats;
                const item = document.createElement('div');
                item.className = 'history-item' + (index === currentDataIndex ? ' active' : '');
                item.onclick = () => loadHistoryData(index);
                item.innerHTML = `
                    <div class="history-run">Run #${allHistoryData.length - index}</div>
                    <div class="history-time">${date.toLocaleString()}</div>
                    <div class="history-stats">‚úì ${stats.passes} | ‚úï ${stats.failures} | ${stats.passPercent}%</div>
                `;
                historyList.appendChild(item);
            });
        }
        
        function loadHistoryData(index) {
            currentDataIndex = index;
            renderDashboard(allHistoryData[index].data);
            populateHistory();
        }
        
        function exportToExcel() {
            if (!allHistoryData || allHistoryData.length === 0) {
                alert('No test data available to export. Make sure the report JSON (json/mochawesome.json) is present and you opened this dashboard via HTTP or have prior runs stored in the browser.');
                return;
            }
            const stats = allHistoryData[currentDataIndex].data.stats || {};
            const filenameBase = `test-report-${new Date().toISOString().split('T')[0]}`;
            try {
                if (typeof XLSX !== 'undefined') {
                    const wb = XLSX.utils.book_new();
                    const summaryData = [['Test Summary Report'], [], ['Metric', 'Value'], ['Generated', new Date().toLocaleString()], ['Total Tests', stats.tests || 0], ['Passed', stats.passes || 0], ['Failed', stats.failures || 0], ['Success Rate', (stats.passPercent || 0) + '%']];
                    const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');
                    const resultsData = [['Test Name', 'Status', 'Duration (s)']];
                    const currentData = allHistoryData[currentDataIndex].data;
                    (currentData.results || []).forEach(result => {
                        if (result.suites) {
                            result.suites.forEach(suite => {
                                (suite.tests || []).forEach(test => {
                                    const durationSec = test.duration ? (test.duration / 1000).toFixed(2) : '';
                                    resultsData.push([test.title || '(no title)', test.pass ? 'PASSED' : 'FAILED', durationSec]);
                                });
                            });
                        }
                    });
                    const resultsSheet = XLSX.utils.aoa_to_sheet(resultsData);
                    XLSX.utils.book_append_sheet(wb, resultsSheet, 'Results');
                    XLSX.writeFile(wb, `${filenameBase}.xlsx`);
                } else {
                    // Fallback: export CSV so users get the data even if SheetJS CDN is blocked
                    const rows = [];
                    rows.push(['Test Summary Report']);
                    rows.push([]);
                    rows.push(['Metric', 'Value']);
                    rows.push(['Generated', new Date().toLocaleString()]);
                    rows.push(['Total Tests', stats.tests || 0]);
                    rows.push(['Passed', stats.passes || 0]);
                    rows.push(['Failed', stats.failures || 0]);
                    rows.push(['Success Rate', (stats.passPercent || 0) + '%']);
                    rows.push([]);
                    rows.push(['Test Name', 'Status', 'Duration (s)']);
                    const currentData = allHistoryData[currentDataIndex].data;
                    (currentData.results || []).forEach(result => {
                        if (result.suites) {
                            result.suites.forEach(suite => {
                                (suite.tests || []).forEach(test => {
                                    const durationSec = test.duration ? (test.duration / 1000).toFixed(2) : '';
                                    rows.push([test.title || '(no title)', test.pass ? 'PASSED' : 'FAILED', durationSec]);
                                });
                            });
                        }
                    });
                    const csv = rows.map(r => r.map(cell => {
                        if (cell == null) return '';
                        const s = String(cell).replace(/"/g, '""');
                        return /[",\n]/.test(s) ? `"${s}"` : s;
                    }).join(',')).join('\r\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${filenameBase}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    URL.revokeObjectURL(link.href);
                    link.remove();
                    alert('SheetJS not available ‚Äî exported CSV instead.');
                }
            } catch (err) {
                console.error('Export failed:', err);
                alert('Export failed ‚Äî see console for details.');
            }
        }

        function setExportEnabled(enabled) {
            const btn = document.querySelector('.control-button');
            if (!btn) return;
            btn.disabled = !enabled;
            btn.style.opacity = enabled ? '1' : '0.5';
            btn.title = enabled ? 'Export to Excel' : 'Export disabled: no data available yet';
        }
        
        function saveHistoryToLocalStorage() {
            try {
                localStorage.setItem('testRunHistory', JSON.stringify(allHistoryData));
            } catch (error) {
                console.warn('LocalStorage unavailable');
            }
        }
        
        function loadHistoryFromLocalStorage() {
            try {
                const stored = localStorage.getItem('testRunHistory');
                if (stored) allHistoryData = JSON.parse(stored);
            } catch (error) {
                console.warn('Error loading from localStorage');
            }
        }
        
        window.addEventListener('load', () => {
            loadHistoryFromLocalStorage();
            // If there is stored history, render it immediately so export works even when fetch from file:// fails
            if (allHistoryData.length > 0) {
                currentDataIndex = 0;
                renderDashboard(allHistoryData[currentDataIndex].data);
                populateHistory();
                setExportEnabled(true);
            } else {
                setExportEnabled(false);
            }
            // Attempt to load fresh JSON; if running from file:// this may fail ‚Äî fallback to localStorage is handled
            loadAndParseTestData();
        });
    </script>
</body>
</html>